name: Deploy CIRISBilling

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual deployment

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.repository == 'CIRISAI/CIRISBilling'
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan 149.28.120.73 >> ~/.ssh/known_hosts

      - name: Deploy code via rsync
        run: |
          rsync -avz --delete \
            --exclude '.git' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.pytest_cache' \
            --exclude '.mypy_cache' \
            --exclude 'htmlcov' \
            --exclude '.coverage' \
            --exclude '*.egg-info' \
            --exclude '.env' \
            --exclude 'venv' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            ./ root@149.28.120.73:/root/CIRISBilling/

      - name: Build and restart services
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 149.28.120.73
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          command_timeout: 10m
          script: |
            set -e
            cd /root/CIRISBilling

            echo "=== Building Docker image ==="
            docker build -t ciris-billing-api:latest .

            echo "=== Reading secrets from Docker volumes ==="
            DB_URL=$(docker run --rm -v cirisbilling_database_url:/vol alpine cat /vol/database_url)
            GOOGLE_SECRET=$(docker run --rm -v cirisbilling_google_client_secret:/vol alpine cat /vol/google_client_secret)
            JWT_SECRET=$(docker run --rm -v cirisbilling_admin_jwt_secret:/vol alpine cat /vol/admin_jwt_secret)
            ENCRYPT_KEY=$(docker run --rm -v cirisbilling_encryption_key:/vol alpine cat /vol/encryption_key)

            echo "=== Reading Play Integrity config from .env ==="
            # Strip surrounding single quotes from service account JSON
            PLAY_INTEGRITY_SA=$(grep -oP "^PLAY_INTEGRITY_SERVICE_ACCOUNT=\K.*" /root/CIRISBilling/.env | sed "s/^'//;s/'$//" || echo "")
            ANDROID_PKG=$(grep -oP '^ANDROID_PACKAGE_NAME=\K.*' /root/CIRISBilling/.env || echo "")
            CIRISLENS_TOKEN=$(grep -oP '^CIRISLENS_TOKEN=\K.*' /root/CIRISBilling/.env || echo "")

            echo "=== Running database migrations (before restart) ==="
            docker exec ciris-billing-api sh -c "export DATABASE_URL='$DB_URL' && alembic upgrade head" || {
              echo "Migration failed or container not running, will run after restart"
            }

            echo "=== Stopping current container ==="
            docker stop ciris-billing-api || true

            echo "=== Removing old container ==="
            docker rm ciris-billing-api || true

            echo "=== Starting new container ==="
            docker run -d \
              --name ciris-billing-api \
              --restart unless-stopped \
              -p 8000:8000 \
              -e ENVIRONMENT=production \
              -e LOG_LEVEL=INFO \
              -e "DATABASE_URL=$DB_URL" \
              -e GOOGLE_CLIENT_ID=265882853697-vsrucm66hl39jei1f5f20kb49om8t9pb.apps.googleusercontent.com \
              -e GOOGLE_CLIENT_IDS=265882853697-vsrucm66hl39jei1f5f20kb49om8t9pb.apps.googleusercontent.com,265882853697-l421ndojcs5nm7lkln53jj29kf7kck91.apps.googleusercontent.com \
              -e "GOOGLE_CLIENT_SECRET=$GOOGLE_SECRET" \
              -e "ADMIN_JWT_SECRET=$JWT_SECRET" \
              -e "ENCRYPTION_KEY=$ENCRYPT_KEY" \
              -e STRIPE_API_KEY=sk_test_placeholder \
              -e STRIPE_PUBLISHABLE_KEY=pk_test_placeholder \
              -e STRIPE_WEBHOOK_SECRET=whsec_placeholder \
              -e "PLAY_INTEGRITY_SERVICE_ACCOUNT=$PLAY_INTEGRITY_SA" \
              -e "ANDROID_PACKAGE_NAME=$ANDROID_PKG" \
              -e "CIRISLENS_TOKEN=$CIRISLENS_TOKEN" \
              --network ciris-billing-network \
              ciris-billing-api:latest

            echo "=== Waiting for service to be ready ==="
            for i in {1..30}; do
              if curl -sf http://localhost:8000/health 2>/dev/null; then
                echo "âœ“ CIRISBilling API is healthy!"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "ERROR: Health check failed after 60 seconds!"
                docker logs ciris-billing-api --tail 50
                exit 1
              fi
              echo "Waiting for API... (attempt $i/30)"
              sleep 2
            done

            echo "=== Running migrations (after restart) ==="
            docker exec ciris-billing-api sh -c "export DATABASE_URL='$DB_URL' && alembic upgrade head"

            echo "=== Deployment complete! ==="

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 149.28.120.73
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "=== Container Status ==="
            docker ps --filter name=billing --format "table {{.Names}}\t{{.Status}}"

            echo -e "\n=== API Health Check ==="
            curl -s http://localhost:8000/health | python3 -m json.tool || echo "Health check failed"

            echo -e "\n=== Database Migration Version ==="
            DB_URL=$(docker run --rm -v cirisbilling_database_url:/vol alpine cat /vol/database_url)
            docker exec ciris-billing-api sh -c "export DATABASE_URL='$DB_URL' && alembic current" || echo "Could not check migration version"

            echo -e "\n=== Recent Logs ==="
            docker logs ciris-billing-api --tail 20
