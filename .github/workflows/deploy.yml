name: Deploy CIRISBilling

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual deployment

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.repository == 'CIRISAI/CIRISBilling'
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan 149.28.120.73 >> ~/.ssh/known_hosts

      - name: Deploy code via rsync
        run: |
          rsync -avz --delete \
            --exclude '.git' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.pytest_cache' \
            --exclude '.mypy_cache' \
            --exclude 'htmlcov' \
            --exclude '.coverage' \
            --exclude '*.egg-info' \
            --exclude '.env' \
            --exclude 'venv' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            ./ root@149.28.120.73:/root/CIRISBilling/

      - name: Build and restart services
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 149.28.120.73
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            set -e
            cd /root/CIRISBilling

            echo "=== Building Docker image ==="
            docker compose build

            echo "=== Running database migrations ==="
            docker exec ciris-billing-api sh -c 'export DATABASE_URL=$(cat /run/secrets/database_url) && alembic upgrade head' || {
              echo "Migration failed or container not running, will run after restart"
            }

            echo "=== Restarting API container ==="
            docker compose up -d ciris-billing-api

            echo "=== Waiting for service to be ready ==="
            for i in {1..30}; do
              if curl -sf http://localhost:8000/health 2>/dev/null; then
                echo "âœ“ CIRISBilling API is healthy!"
                break
              fi
              if [ $i -eq 30 ]; then
                echo "ERROR: Health check failed after 60 seconds!"
                docker logs ciris-billing-api --tail 50
                exit 1
              fi
              echo "Waiting for API... (attempt $i/30)"
              sleep 2
            done

            echo "=== Ensuring migrations are up to date ==="
            docker exec ciris-billing-api sh -c 'export DATABASE_URL=$(cat /run/secrets/database_url) && alembic upgrade head'

            echo "=== Deployment complete! ==="

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: 149.28.120.73
          username: root
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "=== Container Status ==="
            docker ps --filter name=billing --format "table {{.Names}}\t{{.Status}}"

            echo -e "\n=== API Health Check ==="
            curl -s http://localhost:8000/health | python3 -m json.tool || echo "Health check failed"

            echo -e "\n=== Database Migration Version ==="
            docker exec ciris-billing-api sh -c 'export DATABASE_URL=$(cat /run/secrets/database_url) && alembic current' || echo "Could not check migration version"

            echo -e "\n=== Recent Logs ==="
            docker logs ciris-billing-api --tail 20
